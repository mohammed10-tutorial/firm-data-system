<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Job Report</title>
<style>
  :root{ --g900:#0f3d2e; --g800:#145a41; --bg:#f6fbf8; --card:#fff; --ink:#1a2421; --muted:#5b6b6f; --line:#e5efe8; }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--ink)}

  /* NAV */
  .nav{position:sticky;top:0;background:#ffffffcc;backdrop-filter:blur(8px);border-bottom:1px solid var(--line);z-index:50}
  .nav-inner{max-width:1200px;margin:0 auto;padding:8px 12px;display:flex;gap:8px;align-items:center}
  .brand{font-weight:800;color:var(--g800);margin-right:8px}
  .tabs{display:flex;gap:6px;flex-wrap:wrap}
  .tab{border:1px solid #d7eadf;background:var(--card);color:var(--g800);padding:6px 12px;border-radius:999px;font-weight:600;text-decoration:none}
  .tab.active{background:var(--g800);color:#fff;border-color:var(--g800)}

  /* TOOLBAR */
  .toolbar{position:sticky;top:46px;z-index:40;background:#ffffffcc;border-bottom:1px solid var(--line);backdrop-filter:blur(8px)}
  .toolbar-inner{max-width:1200px;margin:0 auto;padding:8px 12px;display:flex;flex-direction:column;gap:8px}

  .toolbar-row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:center}
  .toolbar select,.toolbar input{padding:6px 8px;border:1px solid #cfe7da;border-radius:10px;background:#fff;font-size:12px;min-height:28px}
  .toolbar input,.toolbar select{width:140px;}
  .btn{appearance:none;border:none;border-radius:10px;padding:8px 10px;font-weight:700;cursor:pointer}
  .btn-primary{background:#1c7a57;color:#fff}
  .btn-soft{background:#fff;border:1px dashed #cfe7da}

  .dateGroup{display:flex;align-items:center;gap:6px;background:#f6fbf8;border:1px solid #cfe7da;border-radius:8px;padding:4px 6px}
  .dateGroup label{font-size:12px;font-weight:600;color:var(--g800)}
  .dateGroup span{font-size:12px;color:var(--muted)}

  /* BODY */
  .wrap{max-width:1200px;margin:10px auto;padding:0 12px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:12px;box-shadow:0 6px 18px rgba(16,45,32,.05)}
  h2.title{text-align:center;font-size:20px;margin:0 0 8px;color:var(--g900)}

  /* COUNTS */
  .counts{display:flex;gap:12px;flex-wrap:wrap;justify-content:center;margin-bottom:10px}
  .countBox{border:1px solid var(--line);border-radius:10px;padding:8px 12px;background:#f6fbf8;font-size:12px;text-align:center}
  .countBox .v{font-size:15px;font-weight:800;color:var(--g800)}

  /* JOB ROWS */
  .jobRow{border:1px solid var(--line);border-radius:10px;padding:10px;margin-bottom:10px;background:#fff}
  .orderHead{font-weight:700;color:var(--g800);margin-bottom:6px;font-size:13px}
  .partyLine{margin-left:12px;font-size:12px;margin-bottom:3px}
  .partyLine b{color:var(--g900)}
  .proc{font-weight:700;color:var(--g800)}
  .procSep{color:#999}

  /* LOADER */
  .loader{position:fixed;inset:0;background:#0006;backdrop-filter:blur(6px);display:none;align-items:center;justify-content:center;z-index:999}
  .ring{width:56px;height:56px;border:5px solid #fff;border-top:5px solid #1c7a57;border-radius:50%;animation:spin 1s linear infinite;box-shadow:0 0 14px #1c7a57}
  @keyframes spin{to{transform:rotate(360deg)}}
</style>
</head>
<body>
  <!-- NAV -->
  <div class="nav">
    <div class="nav-inner">
      <div class="brand">Tabs</div>
      <div class="tabs">
        <a class="tab" href="order.html">Add Order</a>
        <a class="tab" href="workflow.html">Workflow</a>
        <a class="tab" href="accounts.html">Accounts</a>
        <a class="tab" href="reports.html">Reports</a>
        <a class="tab active" href="jobreport.html">Job Report</a>
      </div>
    </div>
  </div>

  <!-- FILTERS -->
  <div class="toolbar">
    <div class="toolbar-inner">
      <!-- Row 1: Date Filters -->
      <div class="toolbar-row">
        <div class="dateGroup">
          <label>Order Date</label>
          <input id="fromDate" type="date" />
          <span>to</span>
          <input id="toDate" type="date" />
        </div>
        <div class="dateGroup">
          <label>Process Date</label>
          <input id="procFromDate" type="date" />
          <span>to</span>
          <input id="procToDate" type="date" />
        </div>
      </div>

      <!-- Row 2: Search & Filters -->
      <div class="toolbar-row">
        <select id="staffSelect"><option value="">All Job Places</option></select>
        <select id="processSelect"><option value="">All Processes</option></select>
        <select id="searchSr"><option value="">All Sr. Nos.</option></select>
        <input id="searchParty" type="text" placeholder="Search Party" />
        <input id="searchProduct" type="text" placeholder="Search Product" />
        <input id="searchSheet" type="text" placeholder="Search Sheet" />
        <button class="btn btn-primary" id="genBtn">Generate</button>
        <button class="btn btn-soft" id="downloadBtn">Download PDF</button>
      </div>
    </div>
  </div>

  <!-- BODY -->
  <div class="wrap">
    <div class="card">
      <h2 class="title">Job Report</h2>
      <div class="counts" id="counts"></div>
      <div id="jobHost"></div>
    </div>
  </div>

  <!-- LOADER -->
  <div class="loader" id="loader"><div class="ring"></div></div>

<script>
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwcf50t0NaZ9C161tedpxs4rRN0zFElewYNNHCucH-_BFno5NER1ZH5rWjKLYqRIJXw/exec"; 
const el = id => document.getElementById(id);
const showLoader = ()=> el("loader").style.display="flex";
const hideLoader = ()=> el("loader").style.display="none";

let ALL_LINES=[];

/* Convert DD/MM/YYYY → YYYY-MM-DD for comparison */
function toYMD(dmy){
  if(!dmy) return "";
  const parts=dmy.split("/");
  if(parts.length!==3) return dmy;
  return `${parts[2]}-${parts[1].padStart(2,"0")}-${parts[0].padStart(2,"0")}`;
}

function parseProcessCell(txt){
  if(!txt) return {staff:"",date:""};
  const s=String(txt).trim();
  const m=s.match(/Expected:\s*(\d{4}-\d{2}-\d{2})/i);
  return {staff:s.split("|")[0].trim(), date:m?m[1]:""};
}

async function api(action, params={}){
  const payload = { action, ...params };
  const body = new URLSearchParams({ payload: JSON.stringify(payload) });
  const res = await fetch(SCRIPT_URL,{method:"POST",body});
  const txt = await res.text();
  let j; try{ j=JSON.parse(txt);}catch(e){throw new Error(txt);}
  if(!j.success) throw new Error(j.message||"fail");
  return j;
}

async function loadAllData(){
  showLoader();
  try{
    const [acc,ord]=await Promise.all([
      api("getAccountsDataPaged",{page:1,pageSize:100000,showReceived:true}),
      api("getOrdersForReports")
    ]);
    const ordMap=new Map();
    (ord.rows||[]).forEach(o=>ordMap.set(`${o.srNo}||${o.party}||${o.product}`,o));

    ALL_LINES=(acc.rows||[]).map(r=>{
      const key=`${r.srNo}||${r.party||""}||${r.product||""}`;
      const o=ordMap.get(key)||{};
      return {
        srNo:String(r.srNo||""),
        sheet:String(r.sheetNm||""),
        orderDt:r.orderDt ? String(r.orderDt) : "", // already dd/MM/yyyy
        sheetSz:r.sheetSz,
        qual:r.qual || "",
        qty:r.qty,
        party:String(r.party||""),
        product:String(r.product||""),
        processes:o.processes||{}
      };
    });

    buildFilters();
    renderFiltered();
  }catch(e){ alert("❌ "+e.message); }
  finally{ hideLoader(); }
}

function buildFilters(){
  // staff
  const names=new Set();
  ALL_LINES.forEach(L=>{
    for(const v of Object.values(L.processes||{})){
      const {staff}=parseProcessCell(v);
      if(staff) names.add(staff);
    }
  });
  el("staffSelect").innerHTML='<option value="">All Staff</option>'+[...names].sort().map(s=>`<option>${s}</option>`).join("");

  // processes
  const procs=["Designing","Paper","Printing","Lamination/UV Coating","Cutting","Half Cutting","Punching","Leaf Printing","Binding","Pasting","Deliver"];
  el("processSelect").innerHTML='<option value="">All Processes</option>'+procs.map(p=>`<option>${p}</option>`).join("");

  // Sr No dropdown
  const srSet=[...new Set(ALL_LINES.map(L=>L.srNo))].sort((a,b)=>a-b);
  el("searchSr").innerHTML='<option value="">All Sr. Nos.</option>'+srSet.map(s=>`<option>${s}</option>`).join("");
}

function renderFiltered(){
  const staff=el("staffSelect").value;
  const proc=el("processSelect").value;
  const from=el("fromDate").value;
  const to=el("toDate").value;
  const procFrom=el("procFromDate").value;
  const procTo=el("procToDate").value;

  const qSr=el("searchSr").value;
  const qParty=(el("searchParty").value||"").toLowerCase();
  const qProd=(el("searchProduct").value||"").toLowerCase();
  const qSheet=(el("searchSheet").value||"").toLowerCase();

  let lines=ALL_LINES.slice();
  if(staff) lines=lines.filter(L=>Object.values(L.processes).some(v=>parseProcessCell(v).staff===staff));
  if(proc) lines=lines.filter(L=>L.processes[proc]);

  // Order Date filter
  if(from||to){
    lines=lines.filter(L=>{
      const dYMD=toYMD(L.orderDt);
      return (!from||dYMD>=from)&&(!to||dYMD<=to);
    });
  }

  // Process Expected Date filter
  if(procFrom||procTo){
    lines=lines.filter(L=>{
      return Object.values(L.processes||{}).some(v=>{
        const {date}=parseProcessCell(v);
        if(!date) return false;
        return (!procFrom||date>=procFrom)&&(!procTo||date<=procTo);
      });
    });
  }

  if(qSr) lines=lines.filter(L=>L.srNo===qSr);
  if(qParty) lines=lines.filter(L=>L.party.toLowerCase().includes(qParty));
  if(qProd) lines=lines.filter(L=>L.product.toLowerCase().includes(qProd));
  if(qSheet) lines=lines.filter(L=>L.sheet.toLowerCase().includes(qSheet));

  render(lines,staff,proc);
}

function render(lines,staff,proc){
  const host=el("jobHost");host.innerHTML="";
  if(!lines.length){host.textContent="No data";el("counts").innerHTML="";return;}

  const bySr=new Map();
  lines.forEach(L=>{
    if(!bySr.has(L.srNo))bySr.set(L.srNo,{...L,parties:[]});
    bySr.get(L.srNo).parties.push(L);
  });

  // counts
  const orders=bySr.size;let parties=0;let procCount={};
  bySr.forEach(o=>{
    o.parties.forEach(p=>{
      parties++;
      for(const [k,v] of Object.entries(p.processes||{})){
        if(!v) continue;
        const {staff:st}=parseProcessCell(v);
        if((!staff||st===staff)&&(!proc||k===proc)){
          procCount[k]=(procCount[k]||0)+1;
        }
      }
    });
  });
  el("counts").innerHTML=`<div class="countBox"><div>Orders</div><div class="v">${orders}</div></div>
    <div class="countBox"><div>Parties</div><div class="v">${parties}</div></div>`+
    Object.entries(procCount).map(([k,v])=>`<div class="countBox"><div>${k}</div><div class="v">${v}</div></div>`).join("");

  bySr.forEach(o=>{
    const div=document.createElement("div");div.className="jobRow";
    div.innerHTML=`<div class="orderHead">
      SrNo: ${o.srNo} | Job: ${o.sheet||""} | Date: ${o.orderDt||""} | Size: ${o.sheetSz||""} | Quality: ${o.qual||""} | Qty: ${o.qty||""}
    </div>`;
    o.parties.forEach(p=>{
      const procs=Object.entries(p.processes||{})
        .filter(([k,v])=>v&&(!proc||k===proc))
        .map(([k,v])=>{
          const {staff:st}=parseProcessCell(v);
          if(staff && st!==staff) return "";
          return `<span class="proc">${k}</span>${st?": "+st:""}`;
        })
        .filter(Boolean)
        .join(' <span class="procSep">|</span> ');
      div.innerHTML+=`<div class="partyLine"><b>${p.party}${p.product?` (${p.product})`:""}</b> – ${procs||"-"}</div>`;
    });
    host.appendChild(div);
  });
}

function exportPdf(){window.print();}

document.addEventListener("DOMContentLoaded",async()=>{
  await loadAllData();
  el("genBtn").addEventListener("click",renderFiltered);
  el("downloadBtn").addEventListener("click",exportPdf);
  ["searchSr","searchParty","searchProduct","searchSheet"]
    .forEach(id=> el(id).addEventListener("input",renderFiltered));
});
</script>
</body>
</html>

